@rendermode InteractiveServer


@page "/tracker"
<PageTitle>Gastritis Tracker</PageTitle>

<div class="container mt-4">

    <div class="text-center mb-4">
        <h2 class="text-primary">🩺 My Gastritis Log</h2>
        <p class="text-muted">Tracking supplements and symptoms for better health.</p>
    </div>
    <hr />
    @if (HistoryLog.Any())
    {
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary mb-3 shadow-sm">
                    <div class="card-header">Total Entries</div>
                    <div class="card-body">
                        <h1 class="card-title text-center">@HistoryLog.Count</h1>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-white bg-success mb-3 shadow-sm">
                    <div class="card-header">Good Days</div>
                    <div class="card-body">
                        <h1 class="card-title text-center">
                            @HistoryLog.Count(x => x.Feeling.ToLower().Contains("good") || x.Feeling.ToLower().Contains("great") || x.Feeling.ToLower().Contains("better"))
                        </h1>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-white bg-danger mb-3 shadow-sm">
                    <div class="card-header">Flare-ups</div>
                    <div class="card-body">
                        <h1 class="card-title text-center">
                            @HistoryLog.Count(x => x.Feeling.ToLower().Contains("pain") || x.Feeling.ToLower().Contains("burning") || x.Feeling.ToLower().Contains("bad"))
                        </h1>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-white bg-warning mb-3 shadow-sm">
                    <div class="card-header">Top Item</div>
                    <div class="card-body">
                        <h2 class="card-title text-center mt-2">
                            @(HistoryLog.GroupBy(x => x.ItemName)
                            .OrderByDescending(g => g.Count())
                            .Select(g => g.Key)
                            .FirstOrDefault())
                        </h2>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (IsLoading)
    {
        <div class="alert alert-info">⌛ Loading your history...</div>
    }
    else
    {
        <div class="row">
            <div class="col-md-5 mb-4">
                <div class="card shadow border-0">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">📝 New Entry</h5>
                    </div>
                    <div class="card-body">
                        <EditForm Model="@NewEntry" OnValidSubmit="SaveEntry" FormName="GastritisLogForm">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <div class="mb-3">
                                <label class="form-label fw-bold">Supplement / Food</label>
                                <InputSelect class="form-select" @bind-Value="NewEntry.ItemName">
                                    <option value="">-- Select --</option>
                                    <option value="Manuka Honey">🍯 Manuka Honey</option>
                                    <option value="Collagen">🦴 Collagen</option>
                                    <option value="Omega 3">🐟 Omega 3</option>
                                    <option value="Magnesium">🧠 Magnesium</option>
                                    <option value="Coffee">☕ Coffee (Be careful!)</option>
                                    <option value="Spicy Food">🌶️ Spicy Food (Be careful!)</option>
                                </InputSelect>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Symptom / Feeling</label>
                                <InputTextArea class="form-control" @bind-Value="NewEntry.Feeling" placeholder="e.g. Burning, Good, Bloated" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Date</label>
                                <InputDate class="form-control" @bind-Value="NewEntry.Date" />
                            </div>

                            <button type="submit" class="btn btn-success w-100">
                                💾 Save to Log
                            </button>
                        </EditForm>
                    </div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">📜 History</h5>

                        @if (HistoryLog.Any())
                        {
                            <button class="btn btn-sm btn-outline-success" @onclick="ExportToExcel">
                                📊 Export to Excel
                            </button>
                        }
                    </div>
                    <div class="card-body">
                        @if (HistoryLog.Count == 0)
                        {
                            <p class="text-muted text-center mt-3">No records yet. Start tracking!</p>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Item</th>
                                            <th>Feeling</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var log in HistoryLog.OrderByDescending(x => x.Date))
                                        {
                                            <tr>
                                                <td>@log.Date.ToShortDateString()</td>
                                                <td>@log.ItemName</td>
                                                <td>
                                                    @if (log.Feeling.ToLower().Contains("pain") || log.Feeling.ToLower().Contains("burning"))
                                                    {
                                                        <span class="badge badge-soft-danger">@log.Feeling</span>
                                                    }
                                                    else if (log.Feeling.ToLower().Contains("good") || log.Feeling.ToLower().Contains("great"))
                                                    {
                                                        <span class="badge badge-soft-success">@log.Feeling</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge badge-soft-secondary">@log.Feeling</span>
                                                    }
                                                </td>
                                                <td>
                                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteRow(log)" 
                                                            title="Delete this entry.">
                                                        ❌
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            <button class="btn btn-outline-danger btn-sm mt-3" @onclick="ClearHIstory">
                                🗑️ Clear History
                            </button>
                        }
                    </div>
                </div>
            </div>

        </div>
    }
</div>